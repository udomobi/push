version: 2
jobs:
  build:
    working_directory: ~/push

    docker:
      - image: ilha/python3-base

      - image: mdillon/postgis
        environment:
          POSTGRES_DB: temba 
          POSTGRES_USER: temba 
          POSTGRES_PASSWORD: temba

      - image: redis

      # - image: elastic/elasticsearch:6.3.1
      #   environment:
      #     ES_JAVA_OPTS: -Xms512m -Xmx512m

    steps:
      - checkout

      - restore_cache:
          keys:
            - pip-dependencies-{{ checksum "pip-freeze.txt" }}
            # fallback to using the latest cache if no exact match is found
            - pip-dependencies-
            - npm-dependencies{{ checksum "package-lock.json" }}

      - run:
          name: install dependencies
          environment:
            ES_VERSION: "6.3.1"
            ES_DOWNLOAD_URL: https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.3.1.tar.gz
          command: |
            wget ${ES_DOWNLOAD_URL}
            tar -xzf elasticsearch-${ES_VERSION}.tar.gz
            ./elasticsearch-${ES_VERSION}/bin/elasticsearch &
            pip install --upgrade pip
            pip --version
            pip install -r pip-freeze.txt --upgrade
            pip install coveralls
            pip install flake8
            python --version

      - run:
          name: install npm dependencies
          command: |
            npm install
            npm run build

      - run:
          name: goflow and indexer
          environment:
            GOFLOW_VERSION: "0.10.20"
            RPINDEXER_VERSION: "1.0.22"
          command: |
            # setup a goflow server instance
            wget https://github.com/nyaruka/goflow/releases/download/v${GOFLOW_VERSION}/goflow_${GOFLOW_VERSION}_linux_amd64.tar.gz
            tar -xvf goflow_${GOFLOW_VERSION}_linux_amd64.tar.gz

            # prepare rp-indexer binary
            wget https://github.com/nyaruka/rp-indexer/releases/download/v${RPINDEXER_VERSION}/rp-indexer_${RPINDEXER_VERSION}_linux_amd64.tar.gz
            tar -xvf rp-indexer_${RPINDEXER_VERSION}_linux_amd64.tar.gz

      - save_cache:
          paths:
            - ./env
          key: pip-dependencies-{{ checksum "pip-freeze.txt" }}

      - save_cache:
          paths:
            - ./node_modules
          key: npm-dependencies{{ checksum "package-lock.json" }}
